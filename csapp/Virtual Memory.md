


![다운로드 (2)](https://user-images.githubusercontent.com/75001605/165001756-6ba069d8-023d-48cb-ada6-73fd8048d2bc.png)

가상 메모리 동작방식.



각 프로그램이 가상의 주소를 사용하도록 하며, CPU가 메모리 참조를 시도할 때는 

MMU(Memory Management Unit)라는 하드웨어 장치를 이용하여 해당 가상 주소(Virtual Address)를 실제 메인 메모리의 물리 주소(Physical Address)로 변환하여 메모리 참조를 진행한다.


가상 메모리는 왜 필요할까?

캐싱, 메모리 메니지, 메모리 프로텍션

메인 메모리를 효율적으로 쓰게 하기위해. 가상주소공간을 우선 디스크에 저장. 자주 사용되는 부분만 메인 메모리로 가져오게끔.

메인 메모리를 디스크의 캐시로 사용. 메인 메모리에 여러 프로그램의 데이터와 코드 로드




다음으로 메모리 관리를 단순화 한다. 가상 메모리 시스템에서는 각 프로세스가 완전히 동일한 포맷의 가상 주소 공간을 가진다.
각각의 프로세스에게ㅅ 혼자서 메인 메모리를 사용한다는 듯한 착각을 제공. 링커 및 로더의 구현과 메모리 할당 방식등을 단순화

메모리 보호 메커니즘을 단순화한다. 
가상 주소를 물리 주소로 변환할 때 참조하는 맵핑 테이블의 각 엔트리에는 해당 가상 주소에 대한 접근 권한이 명시된다. 따라서 유저 프로세스가 커널 영역에 접근하는 것처럼 허용되지 않은 주소 공간에 접근하는 것도 쉽게 막을 수 있다.





가상 메모리는 디스크에 저장되는 N개의 연속적인 바이트들로 이뤄진 배열을 의미하며, 해당 바이트 배열의 일부는 메인 메모리(DRAM 캐시)에 캐시 된다. 



캐시 메모리가 메인 메모리의 캐시로 사용된다면, 메인 메모리는 디스크의 캐시로 사용되는 셈이다. 그리고 캐시 메모리와 DRAM의 관계에서 블록(Block)이라는 단위를 사용하듯이, 메인 메모리와 디스크의 관계에서는 *** 페이지(Page) *** 라는 단위를 사용한다.



가상 주소 공간(Virtual Address Space)의 각 페이지는 가상 페이지(Virtual Address), 메인 메모리에 위치하는 물리 주소 공간(Physical Address Space)의 각 페이지는 물리 페이지(Physical Page)





Address Translation 주소변환

페이지 테이블 엔트리 정보를 바탕으로 가상주소를 물리주소로 변환하는 과정


변환하고자 하는 가상 주소에 해당하는 PTE를 찾아간다. 만약 PTE의 VALID 비트가 0인데 그곳에 디스크의 특정 위치 정보가

저장 되어있다면, 해당 가상 페이지가 물리 페이지에 맵핑된게 아님. 페이지 폴트 예외 발생.

VALID BIT가 1이면 가상 페이지가 물리페이지에 맵핑되있다는것. PTE 에서 맵핑된 물리페이지의 번호를 알아낸다.


페이지 테이블 자체의 시작 주소는 
CPU내 페이지 테이블 베이스레지스터에 저장된다.


TLB는 메인 메모리에 존재하는 페이지 테이블의 캐시로서, MMU 내부에 존재하는 작은 하드웨어 버퍼 장치를 의미한다

TLB에는  참조되는 빈도가 높은 ㅔ이지 테이블 엔트리들이 저장된다. 캐시 메모리가 메인 메모리의 캐시로 사용되는 것과 마찬가지 관계.

따라서 TLB히트가 발생하면 페이지 테이블 참조를 위해 메인 메모리에 찾아갈 필요가 없어짐.

만약. TLB가 없다면~ 페이지 테이블을 참조하는 과정에만 최소한 1번의 메모리 참조를 진행.


TLB에 접근해 PTE가져오는 과정. PTE의 주소는 가상주소의 VPN을 통해 알아낸다.

TLB에 접근할 때도 가상 주소의 VPN을 입력. 


7.CASE STUDY. INTEL CORE I7/Linux memory system

i7의 메모리 시스템. 프로세서 에는 4개의 코어, 모든 코어가 공유하는 L3 캐시와 메인 메모리의 인터페이스에 해당하는 DDR3 메모리 컨트롤러

각각의 코어는 데이터 및 명령어를 참조를 위한 캐시 계층, pte 참조를 위한 TLB 계층도 갖추고있음



![다운로드](https://user-images.githubusercontent.com/75001605/165004915-5d99e9ca-e078-47e8-85af-13cc7caf6d09.png)


7-2. 메모리 참조 전체 과정.

인텔코어 I7 CPU의 전체적인 메모리 참조과정. 각 프로세스는 4단계 페이지 테이블 계층 가짐

CR3는 첫번째 단계 페이지 테이블의 물리적인 시작 주소를 저장하는 컨트롤 레지스터, 각 프로세스의 문맥에 포함되는 상태 정보이다.













